/*
 * This file is part of the Archon library framework.
 *
 * Copyright (C) 2012  Kristian Spangsege <kristian.spangsege@gmail.com>
 *
 * The Archon library framework is free software: You can redistribute
 * it and/or modify it under the terms of the GNU Lesser General
 * Public License as published by the Free Software Foundation, either
 * version 3 of the License, or (at your option) any later version.
 *
 * The Archon library framework is distributed in the hope that it
 * will be useful, but WITHOUT ANY WARRANTY; without even the implied
 * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with the Archon library framework.  If not, see
 * <http://www.gnu.org/licenses/>.
 */

/**
 * \file
 *
 * \author Kristian Spangsege
 */

#include <cstddef>
#include <cmath>
#include <stdexcept>

#include <archon/util/prime.hpp>


using namespace std;


namespace
{
  long primes_for_powers_of_two[] =
  {
    // Primes near powers of two:
    //
    // For any integer index 'i' such that 0 <= i < 236:
    //
    //   2**(3/2+i/8) <= ceil(2**(3/2+i/8)) <= primes_for_powers_of_two[i]
    //
    // For any number 'n' such that 3 <= n <= floor(2**30.875) = 1969251187
    //
    //   n <= 2**(3/2+ceil(8*(log2(n)-3/2))/8) <= primes_for_powers_of_two[ceil(8*(log2(n)-3/2))]
    //
    //
    //                                     First prime greater         Prime
    //                    Ceiling of          than or equal to         value
    // Expopnent        power of two              power of two       increase
    // -----------------------------------------------------------------------
    /*   1.500                     3  */                     3,     //   0.0%
    /*   1.625                     4  */                     5,     //  66.7%
    /*   1.750                     4  */                     5,     //   0.0%
    /*   1.875                     4  */                     5,     //   0.0%
    /*   2.000                     4  */                     5,     //   0.0%
    /*   2.125                     5  */                     5,     //   0.0%
    /*   2.250                     5  */                     5,     //   0.0%
    /*   2.375                     6  */                     7,     //  40.0%
    /*   2.500                     6  */                     7,     //   0.0%
    /*   2.625                     7  */                     7,     //   0.0%
    /*   2.750                     7  */                     7,     //   0.0%
    /*   2.875                     8  */                    11,     //  57.1%
    /*   3.000                     8  */                    11,     //   0.0%
    /*   3.125                     9  */                    11,     //   0.0%
    /*   3.250                    10  */                    11,     //   0.0%
    /*   3.375                    11  */                    11,     //   0.0%
    /*   3.500                    12  */                    13,     //  18.2%
    /*   3.625                    13  */                    13,     //   0.0%
    /*   3.750                    14  */                    17,     //  30.8%
    /*   3.875                    15  */                    17,     //   0.0%
    /*   4.000                    16  */                    17,     //   0.0%
    /*   4.125                    18  */                    19,     //  11.8%
    /*   4.250                    20  */                    23,     //  21.0%
    /*   4.375                    21  */                    23,     //   0.0%
    /*   4.500                    23  */                    23,     //   0.0%
    /*   4.625                    25  */                    29,     //  26.1%
    /*   4.750                    27  */                    29,     //   0.0%
    /*   4.875                    30  */                    31,     //   6.9%
    /*   5.000                    32  */                    37,     //  19.4%
    /*   5.125                    35  */                    37,     //   0.0%
    /*   5.250                    39  */                    41,     //  10.8%
    /*   5.375                    42  */                    43,     //   4.9%
    /*   5.500                    46  */                    47,     //   9.3%
    /*   5.625                    50  */                    53,     //  12.8%
    /*   5.750                    54  */                    59,     //  11.3%
    /*   5.875                    59  */                    59,     //   0.0%
    /*   6.000                    64  */                    67,     //  13.6%
    /*   6.125                    70  */                    71,     //   6.0%
    /*   6.250                    77  */                    79,     //  11.3%
    /*   6.375                    83  */                    83,     //   5.1%
    /*   6.500                    91  */                    97,     //  16.9%
    /*   6.625                    99  */                   101,     //   4.1%
    /*   6.750                   108  */                   109,     //   7.9%
    /*   6.875                   118  */                   127,     //  16.5%
    /*   7.000                   128  */                   131,     //   3.2%
    /*   7.125                   140  */                   149,     //  13.7%
    /*   7.250                   153  */                   157,     //   5.4%
    /*   7.375                   166  */                   167,     //   6.4%
    /*   7.500                   182  */                   191,     //  14.4%
    /*   7.625                   198  */                   199,     //   4.2%
    /*   7.750                   216  */                   223,     //  12.1%
    /*   7.875                   235  */                   239,     //   7.2%
    /*   8.000                   256  */                   257,     //   7.5%
    /*   8.125                   280  */                   281,     //   9.3%
    /*   8.250                   305  */                   307,     //   9.2%
    /*   8.375                   332  */                   337,     //   9.8%
    /*   8.500                   363  */                   367,     //   8.9%
    /*   8.625                   395  */                   397,     //   8.2%
    /*   8.750                   431  */                   431,     //   8.6%
    /*   8.875                   470  */                   479,     //  11.1%
    /*   9.000                   512  */                   521,     //   8.8%
    /*   9.125                   559  */                   563,     //   8.1%
    /*   9.250                   609  */                   613,     //   8.9%
    /*   9.375                   664  */                   673,     //   9.8%
    /*   9.500                   725  */                   727,     //   8.0%
    /*   9.625                   790  */                   797,     //   9.6%
    /*   9.750                   862  */                   863,     //   8.3%
    /*   9.875                   940  */                   941,     //   9.0%
    /*  10.000                  1024  */                  1031,     //   9.6%
    /*  10.125                  1117  */                  1117,     //   8.3%
    /*  10.250                  1218  */                  1223,     //   9.5%
    /*  10.375                  1328  */                  1361,     //  11.3%
    /*  10.500                  1449  */                  1451,     //   6.6%
    /*  10.625                  1580  */                  1583,     //   9.1%
    /*  10.750                  1723  */                  1723,     //   8.8%
    /*  10.875                  1879  */                  1879,     //   9.1%
    /*  11.000                  2048  */                  2053,     //   9.3%
    /*  11.125                  2234  */                  2237,     //   9.0%
    /*  11.250                  2436  */                  2437,     //   8.9%
    /*  11.375                  2656  */                  2657,     //   9.0%
    /*  11.500                  2897  */                  2897,     //   9.0%
    /*  11.625                  3159  */                  3163,     //   9.2%
    /*  11.750                  3445  */                  3449,     //   9.0%
    /*  11.875                  3757  */                  3761,     //   9.1%
    /*  12.000                  4096  */                  4099,     //   9.0%
    /*  12.125                  4467  */                  4481,     //   9.3%
    /*  12.250                  4871  */                  4871,     //   8.7%
    /*  12.375                  5312  */                  5323,     //   9.3%
    /*  12.500                  5793  */                  5801,     //   9.0%
    /*  12.625                  6317  */                  6317,     //   8.9%
    /*  12.750                  6889  */                  6899,     //   9.2%
    /*  12.875                  7513  */                  7517,     //   9.0%
    /*  13.000                  8192  */                  8209,     //   9.2%
    /*  13.125                  8934  */                  8941,     //   8.9%
    /*  13.250                  9742  */                  9743,     //   9.0%
    /*  13.375                 10624  */                 10627,     //   9.1%
    /*  13.500                 11586  */                 11587,     //   9.0%
    /*  13.625                 12634  */                 12637,     //   9.1%
    /*  13.750                 13778  */                 13781,     //   9.1%
    /*  13.875                 15025  */                 15031,     //   9.1%
    /*  14.000                 16384  */                 16411,     //   9.2%
    /*  14.125                 17867  */                 17881,     //   9.0%
    /*  14.250                 19484  */                 19489,     //   9.0%
    /*  14.375                 21248  */                 21269,     //   9.1%
    /*  14.500                 23171  */                 23173,     //   8.9%
    /*  14.625                 25268  */                 25301,     //   9.2%
    /*  14.750                 27555  */                 27581,     //   9.0%
    /*  14.875                 30049  */                 30059,     //   9.0%
    /*  15.000                 32768  */                 32771,     //   9.0%
    /*  15.125                 35734  */                 35747,     //   9.1%
    /*  15.250                 38968  */                 38971,     //   9.0%
    /*  15.375                 42495  */                 42499,     //   9.1%
    /*  15.500                 46341  */                 46349,     //   9.1%
    /*  15.625                 50536  */                 50539,     //   9.0%
    /*  15.750                 55109  */                 55109,     //   9.0%
    /*  15.875                 60097  */                 60101,     //   9.1%
    /*  16.000                 65536  */                 65537,     //   9.0%
    /*  16.125                 71468  */                 71471,     //   9.1%
    /*  16.250                 77936  */                 77951,     //   9.1%
    /*  16.375                 84990  */                 84991,     //   9.0%
    /*  16.500                 92682  */                 92683,     //   9.1%
    /*  16.625                101071  */                101081,     //   9.1%
    /*  16.750                110218  */                110221,     //   9.0%
    /*  16.875                120194  */                120199,     //   9.1%
    /*  17.000                131072  */                131101,     //   9.1%
    /*  17.125                142936  */                142939,     //   9.0%
    /*  17.250                155872  */                155887,     //   9.1%
    /*  17.375                169980  */                169987,     //   9.1%
    /*  17.500                185364  */                185369,     //   9.1%
    /*  17.625                202141  */                202183,     //   9.1%
    /*  17.750                220436  */                220447,     //   9.0%
    /*  17.875                240388  */                240421,     //   9.1%
    /*  18.000                262144  */                262147,     //   9.0%
    /*  18.125                285871  */                285871,     //   9.1%
    /*  18.250                311744  */                311747,     //   9.1%
    /*  18.375                339959  */                339959,     //   9.1%
    /*  18.500                370728  */                370759,     //   9.1%
    /*  18.625                404282  */                404291,     //   9.0%
    /*  18.750                440872  */                440893,     //   9.1%
    /*  18.875                480775  */                480787,     //   9.1%
    /*  19.000                524288  */                524309,     //   9.1%
    /*  19.125                571741  */                571741,     //   9.1%
    /*  19.250                623488  */                623521,     //   9.1%
    /*  19.375                679918  */                679919,     //   9.1%
    /*  19.500                741456  */                741457,     //   9.1%
    /*  19.625                808563  */                808579,     //   9.1%
    /*  19.750                881744  */                881779,     //   9.1%
    /*  19.875                961549  */                961549,     //   9.1%
    /*  20.000               1048576  */               1048583,     //   9.1%
    /*  20.125               1143481  */               1143481,     //   9.1%
    /*  20.250               1246975  */               1246997,     //   9.1%
    /*  20.375               1359835  */               1359857,     //   9.1%
    /*  20.500               1482911  */               1482919,     //   9.1%
    /*  20.625               1617126  */               1617137,     //   9.1%
    /*  20.750               1763488  */               1763491,     //   9.1%
    /*  20.875               1923097  */               1923107,     //   9.1%
    /*  21.000               2097152  */               2097169,     //   9.1%
    /*  21.125               2286961  */               2286961,     //   9.1%
    /*  21.250               2493949  */               2493949,     //   9.1%
    /*  21.375               2719670  */               2719699,     //   9.1%
    /*  21.500               2965821  */               2965847,     //   9.1%
    /*  21.625               3234251  */               3234251,     //   9.1%
    /*  21.750               3526976  */               3526987,     //   9.1%
    /*  21.875               3846194  */               3846197,     //   9.1%
    /*  22.000               4194304  */               4194319,     //   9.1%
    /*  22.125               4573921  */               4573931,     //   9.1%
    /*  22.250               4987897  */               4987901,     //   9.1%
    /*  22.375               5439340  */               5439341,     //   9.1%
    /*  22.500               5931642  */               5931649,     //   9.1%
    /*  22.625               6468502  */               6468509,     //   9.1%
    /*  22.750               7053951  */               7053971,     //   9.1%
    /*  22.875               7692388  */               7692389,     //   9.1%
    /*  23.000               8388608  */               8388617,     //   9.1%
    /*  23.125               9147842  */               9147857,     //   9.1%
    /*  23.250               9975793  */               9975803,     //   9.1%
    /*  23.375              10878679  */              10878709,     //   9.1%
    /*  23.500              11863284  */              11863289,     //   9.1%
    /*  23.625              12937003  */              12937007,     //   9.1%
    /*  23.750              14107901  */              14107921,     //   9.1%
    /*  23.875              15384775  */              15384821,     //   9.1%
    /*  24.000              16777216  */              16777259,     //   9.1%
    /*  24.125              18295684  */              18295687,     //   9.1%
    /*  24.250              19951585  */              19951597,     //   9.1%
    /*  24.375              21757358  */              21757361,     //   9.1%
    /*  24.500              23726567  */              23726569,     //   9.1%
    /*  24.625              25874005  */              25874027,     //   9.1%
    /*  24.750              28215802  */              28215809,     //   9.1%
    /*  24.875              30769550  */              30769567,     //   9.1%
    /*  25.000              33554432  */              33554467,     //   9.1%
    /*  25.125              36591368  */              36591383,     //   9.1%
    /*  25.250              39903170  */              39903197,     //   9.1%
    /*  25.375              43514715  */              43514717,     //   9.1%
    /*  25.500              47453133  */              47453149,     //   9.1%
    /*  25.625              51748009  */              51748043,     //   9.1%
    /*  25.750              56431604  */              56431657,     //   9.1%
    /*  25.875              61539100  */              61539113,     //   9.1%
    /*  26.000              67108864  */              67108879,     //   9.1%
    /*  26.125              73182736  */              73182743,     //   9.1%
    /*  26.250              79806339  */              79806341,     //   9.1%
    /*  26.375              87029430  */              87029471,     //   9.1%
    /*  26.500              94906266  */              94906297,     //   9.1%
    /*  26.625             103496017  */             103496027,     //   9.1%
    /*  26.750             112863207  */             112863217,     //   9.1%
    /*  26.875             123078200  */             123078209,     //   9.1%
    /*  27.000             134217728  */             134217757,     //   9.1%
    /*  27.125             146365471  */             146365487,     //   9.1%
    /*  27.250             159612678  */             159612679,     //   9.1%
    /*  27.375             174058859  */             174058861,     //   9.1%
    /*  27.500             189812532  */             189812533,     //   9.1%
    /*  27.625             206992034  */             206992043,     //   9.1%
    /*  27.750             225726413  */             225726419,     //   9.1%
    /*  27.875             246156399  */             246156401,     //   9.1%
    /*  28.000             268435456  */             268435459,     //   9.1%
    /*  28.125             292730941  */             292730989,     //   9.1%
    /*  28.250             319225355  */             319225391,     //   9.1%
    /*  28.375             348117718  */             348117739,     //   9.1%
    /*  28.500             379625063  */             379625083,     //   9.1%
    /*  28.625             413984067  */             413984099,     //   9.1%
    /*  28.750             451452826  */             451452839,     //   9.1%
    /*  28.875             492312797  */             492312797,     //   9.1%
    /*  29.000             536870912  */             536870923,     //   9.1%
    /*  29.125             585461881  */             585461917,     //   9.1%
    /*  29.250             638450709  */             638450719,     //   9.1%
    /*  29.375             696235435  */             696235447,     //   9.1%
    /*  29.500             759250125  */             759250133,     //   9.1%
    /*  29.625             827968133  */             827968151,     //   9.1%
    /*  29.750             902905651  */             902905657,     //   9.1%
    /*  29.875             984625594  */             984625687,     //   9.1%
    /*  30.000            1073741824  */            1073741827,     //   9.1%
    /*  30.125            1170923762  */            1170923777,     //   9.1%
    /*  30.250            1276901417  */            1276901429,     //   9.1%
    /*  30.375            1392470869  */            1392470869,     //   9.1%
    /*  30.500            1518500250  */            1518500279,     //   9.1%
    /*  30.625            1655936265  */            1655936281,     //   9.1%
    /*  30.750            1805811302  */            1805811341,     //   9.1%
    /*  30.875            1969251188  */            1969251217,     //   9.1%
    //
    // The table is based on output from this shell script:
    //
    //   prev=2; for((i=12;i<248;++i)); do
    //     exp="$(calc -p -- "$i/8")";
    //     pow="$(calc -p -- "ceil(2^$exp)")";
    //     pri="$(matho-primes $pow $((pow+200)) | head -n 1)";
    //     inc="$(calc -p -- "round(100*($pri-$prev)/$prev,2)")";
    //     prev="$pri";
    //     printf '    /* %6.2f   %20d  */  %20d,     // %5.1f%%\n' "$exp" "$pow" "$pri" "$inc";
    //   done
  };
}


namespace archon
{
  namespace util
  {
    // FIXME: log2 is not in C++03
    long get_prime_not_under(long n)
    {
      if (n < 3) return 1 < n ? 2 : 1;
      if (1969251187 < n) return 1969251217 < n ? 2147483647 : 1969251217;
      unsigned const i = unsigned(ceil(8*(log2(n)-1.5)));
      long const p = primes_for_powers_of_two[i-1];
      return p < n ? primes_for_powers_of_two[i] : p;
    }
  }
}
